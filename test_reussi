#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <time.h>
#include <sys/stat.h>
#include <sys/types.h>
#define NbAnimal 50
#define MAX 1000


typedef enum{
    chien = 1, 
    chat, 
    hamster,
    autruche
}Espece;

typedef struct{
    int id;
    int annee;
    float poids;
    char nom[MAX];
    char descrip[MAX];
    Espece espece;
}Animal;

Animal refuge[NbAnimal];        // tableau d'animal qui stocke les animaux de tout le refuge
int nb_animal= 0;               // initialise le nombre d'animaux √† 0
int prochain_id=1;

// Fonction pour afficher les informations d‚Äôun animal
void afficheAnimal(Animal a, int choix){
    printf("-----\n");  
    printf("Nom : %s\n", a.nom);         // Affichage du nom de l‚Äôanimal
    printf("id : %d\n", a.id);           // Affichage de l‚Äôid
    printf("annee : %d\n", a.annee);     // Affichage de l‚Äôann√©e de naissance
    printf("poids : %.2f kg\n", a.poids); // Affichage du poids

    // Affichage de l'esp√®ce 
    switch(a.espece){
        case 1 :
            printf("Espece : chien \n");
            break;
        case 2 :
            printf("Espece : chat \n");
            break;
        case 3 :
            printf("Espece : Hamster \n");
            break;
        case 4 :
            printf("Espece : Autruche \n");
            break;
        default:
            printf("Espece : inconnue \n"); // S√©curit√© si valeur inattendue
            break;
    }

    // Affichage aussi la description
    if(choix == 1){  
        printf("description : %s\n", a.descrip);
    }

    printf("-----\n");  
}

// Fonction pour sauvegarder les animaux depuis un fichier
void sauvegarder_animaux() {
    // Cr√©ation du dossier "sauvegardes" 
    mkdir("sauvegardes", 0777);

    // Nom de fichier fixe (toujours le m√™me)
    const char* fichier = "sauvegardes/animaux.txt";

    // Ouverture du fichier en √©criture (√©crase l'ancien)
    FILE* F = fopen(fichier, "w");
    if (F==NULL) {
        perror("Erreur d'ouverture du fichier de sauvegarde");
        return;
    }

    // √âcriture des donn√©es
    for (int i = 0; i < nb_animal; i++) {
        fprintf(F, "%d;%s;%d;%d;%.2f;%s\n",
                refuge[i].id,
                refuge[i].nom,
                refuge[i].espece,
                refuge[i].annee,
                refuge[i].poids,
                refuge[i].descrip);
    }

    fclose(F);
}


// Fonction pour charger les animaux depuis un fichier
void charger_animaux() {
    const char* fichier = "sauvegardes/animaux.txt";
    FILE* F = fopen(fichier, "r");
    if (F==NULL) {
        perror("Fichier introuvable ou erreur d'ouverture");
        return;
    }

    nb_animal = 0;  // R√©initialise le compteur avant chargement

    while (nb_animal < NbAnimal &&
           fscanf(F, "%d;%999[^;];%d;%d;%f;%999[^\n]\n",
                  &refuge[nb_animal].id,
                  refuge[nb_animal].nom,
                  (int*)&refuge[nb_animal].espece,
                  &refuge[nb_animal].annee,
                  &refuge[nb_animal].poids,
                  refuge[nb_animal].descrip) == 6) {
        nb_animal++;
    }

    fclose(F);
}

// Fonction pour ajouter un animal au refuge
void ajouter_animal() { 		
   
    if (nb_animal >= NbAnimal) {	 // V√©rifie si la capacit√© maximale est atteinte
        printf("Capacit√© maximale atteinte.\n");
    } else {	
        Animal a;                        // D√©clare une variable de type Animal
        a.id = prochain_id++;           // g√©n√®re un identifiant unique automatiquement

        // Saisie du nom de l'animal
        do{
        printf("Nom : ");
        fgets(a.nom, MAX, stdin);       // lire une cha√Æne avec espaces
        a.nom[strcspn(a.nom, "\n")] = '\0';  // enl√®ve le '\n' de la cha√Æne du nom
    }while(a.nom[0]== '\0');

        // Saisie du type d'esp√®ce 
        do {
            printf("Esp√®ce (1:Chien, 2:Chat, 3:Hamster, 4:Autruche) : ");
            scanf("%d", (int*)&a.espece);
            while (getchar() != '\n');  // supprimer le '\n' du tampon
        } while(a.espece < 1 || a.espece > 4);

        // Saisie de l‚Äôann√©e de naissance
        do {
            printf("Ann√©e de naissance : ");
            scanf("%d", &a.annee);
            while (getchar() != '\n');  
        } while(a.annee < 0);
        
        // Saisie du poids 
        do {
            printf("Poids (kg) : ");
            scanf("%f", &a.poids);
            while (getchar() != '\n');
        } while(a.poids <= 0);   

        int choix;
        // Demande pour ajouter une description 
        do {
            printf("Voulez-vous ajouter une description ? (1:Oui / 0:Non) : ");
            scanf("%d", &choix);
            while (getchar() != '\n');  // enl√®ve le '\n'
        } while(choix != 1 && choix != 0);

        // Saisie de la description si l'utilisateur a choisi oui
        if (choix == 1) {
            do{
            printf("Description : \n");
            fgets(a.descrip, MAX, stdin);                    
            a.descrip[strcspn(a.descrip, "\n")] = '\0';
            }while(a.descrip[0]== '\0');      
        }

        // Ajout de l'animal au tableau refuge 
        refuge[nb_animal++] = a;

        // Affichage des caract√©ristique de l‚Äôanimal ajout√©
        afficheAnimal(a, choix);

        printf("‚úÖ Animal ajout√© avec succ√®s.\n");

        // Sauvegarde dans le fichier 
        sauvegarder_animaux();  
    }
}


// Fonction qui permet d‚Äôadopter (supprimer) un animal du refuge selon son identifiant
void adopter_animal() {
    int id;  // Variable de l'id de l‚Äôanimal √† adopter 

    // Saisir l'id de l'animal √† adopter
    do {
        printf("ID de l'animal √† adopter (entier positif) : ");
        scanf("%d", &id);
        while (getchar() != '\n');  // supprimer le '\n' du tampon
    } while (id <= 0);  // L‚ÄôID doit √™tre strictement positif

    int trouv√© = 0;  // Marqueur pour savoir si l‚Äôanimal correspondant √† l‚Äôid a √©t√© trouv√©

    // Parcours du tableau des animaux
    for (int i = 0; i < nb_animal; i++) {
        if (refuge[i].id == id) {  // Si l'id de l'animal correspond √† celui recherch√©
            trouv√© = 1;            //  on a trouv√© l‚Äôanimal

            printf("Animal trouv√© :\n");
            afficheAnimal(refuge[i], 1);  // Affiche les d√©tails de l‚Äôanimal trouv√©

            // R√©ajustement des indices : on d√©cale les animaux suivants d‚Äôune position vers la gauche
            for (int j = i; j < nb_animal - 1; j++) {
                refuge[j] = refuge[j + 1];  // √âcrase les donn√©es de refuge[i] avec refuge[i+1]
            }

            nb_animal--;  // On retire le nombre animal car un animal a √©t√© supprim√©
            printf("Animal avec ID %d adopt√© avec succ√®s.\n", id);
            break;        // Sort de la boucle apr√®s adoption
        }
    }

    // le cas o√π aucun animal n‚Äôa √©t√© trouv√© avec l‚ÄôID saisi
    if (trouv√© == 0) {
        printf("Aucun animal trouv√© avec l'ID %d.\n", id);
    }

    // Sauvegarde la nouvelle liste d'animaux apr√®s adoption
    sauvegarder_animaux();
}

// Fonction permettant de d√©terminer l'ann√©e actuel automatiquement
int AnneeCourante(){
    int annee_actuel;
    time_t ts = time(NULL);    //time_t permet de d√©clarer une variable en seconde depuis 1970. time(NULL) c'est une fonction qui sert √† obtenir le temps actuel en seconde. 
    annee_actuel = 1970 + (ts/(60*60*24*365));   // on fait la conversion de ts en ann√©e puis on ajoute 1970.
    return annee_actuel;
 } 

// Fonction permettant de rechercher des animaux selon plusieurs crit√®res (nom, esp√®ce, √¢ge)
void rechercher_animaux() {
    Animal a;                      // Variable  pour parcourir le tableau
    char nom[MAX];                // Nom √† saisir
    int filtre_espece, age_type;  // Variables pour filtrer esp√®ce et type d‚Äô√¢ge
    int critere_nom = 0, critere_espece = 0, critere_age = 0; // Variable pour savoir les filtres saisir

    // Demande si l'utilisateur veut filtrer par nom
    printf("Rechercher par nom ? (1:Oui / 0:Non) : ");
    scanf("%d", &critere_nom);
    while (getchar() != '\n');  // supprime '\n' du tampon
    if (critere_nom == 1) {
        do{
            printf("Nom : \n");
            fgets(a.nom, MAX, stdin);       // lire une cha√Æne avec espaces
            a.nom[strcspn(a.nom, "\n")] = '\0';  // enl√®ve le '\n' de la cha√Æne du nom
        }while(a.nom[0]== '\0');
    }

    // Demande si l'utilisateur veut filtrer par esp√®ce
    printf("Rechercher par esp√®ce ? (1:Oui / 0:Non) : ");
    scanf("%d", &critere_espece);
    while (getchar() != '\n');
    if (critere_espece == 1) {
        printf("Esp√®ce (1:Chien, 2:Chat, 3:Hamster, 4:Autruche) : ");
        scanf("%d", &filtre_espece);
        while (getchar() != '\n');
    }

    // Demande si l'utilisateur veut filtrer par √¢ge
    printf("Rechercher par type d'√¢ge ? (1:Oui / 0:Non) : ");
    scanf("%d", &critere_age);
    while (getchar() != '\n');
    if (critere_age == 1) {
        printf("1: Jeune (<2 ans), 2: Senior (>10 ans) : ");
        scanf("%d", &age_type);
        while (getchar() != '\n');
    }

    int trouve = 0;                // Marqueur pour savoir si un animal a √©t√© trouv√©
    int annee_courante = AnneeCourante();     // Ann√©e actuelle pour le calcul de l‚Äô√¢ge

    // Parcours de tous les animaux du refuge
    for (int i = 0; i < nb_animal; i++) {
        a = refuge[i];
        int age = annee_courante - a.annee;  // Calcul de l‚Äô√¢ge de l‚Äôanimal

        int repere = 1;  //v√©rifie si l‚Äôanimal correspond √† tous les filtres

        // Filtre par nom 
        if (critere_nom == 1 && strcmp(a.nom, nom) != 0){
            repere = 0;
        }
        // Filtre par esp√®ce
        if (critere_espece == 1 && a.espece != (Espece)filtre_espece){
            repere = 0;
        }                
        // Filtre par type d‚Äô√¢ge 
        if (critere_age == 1) {
            if ((age_type == 1 && age >= 2) || (age_type == 2 && age <= 10)){
                repere = 0;
            }       
        }

        // Si l‚Äôanimal v√©rifie les filtres, on l‚Äôaffiche
        if (repere == 1) {
            afficheAnimal(a, 1);  // Affichage des caract√©ristiques de l'animal
            trouve = 1;
        }
    }

    // le cas o√π aucun animal n‚Äôa √©t√© trouv√©
    if (trouve == 0){
        printf("Aucun animal ne correspond aux crit√®res.\n");
    }
}

// Fonction permettant de modifier les informations d‚Äôun animal identifi√© par son ID
void modifierAnimal() {
    int id;         // Variable  de l‚Äôid saisi par l‚Äôutilisateur
    int trouve = 0; // Marqueur pour v√©rifier si l‚Äôanimal a √©t√© trouv√©

    //  saisir un id valide
    do {
        printf("ID de l'animal √† modifier : ");
        scanf("%d", &id);
        while (getchar() != '\n'); // supprime le '\n' du tampon
    } while (id <= 0);

    // Parcours de tous les animaux du refuge pour chercher celui avec l‚Äôid correspondant
    for (int i = 0; i < nb_animal; i++) {
        if (refuge[i].id == id) { // Si l‚ÄôID correspond √† celui d‚Äôun animal du tableau
            trouve = 1; // L‚Äôanimal est trouv√©

            // Affiche les caract√©ristiques de l‚Äôanimal avant modification
            afficheAnimal(refuge[i], 1);

            int modif; // Variable pour le choix de l‚Äôutilisateur

            // Affiche les diff√©rentes modifications possibles
            do {
                printf("Modifier: 1.nom || 2.ann√©e de naissance || 3.esp√®ce || 4.poids || 5.description : ");
                scanf("%d", &modif);
                while (getchar() != '\n'); 
            } while (modif < 1 || modif > 5);

            // on modifie le crit√®re correspondant
            switch (modif) {
                case 1: // Modification du nom
                 do {
				printf("Nouveau nom : ");
				fgets(refuge[i].nom, MAX, stdin);
				refuge[i].nom[strcspn(refuge[i].nom, "\n")] = '\0'; // supprime \n

				if (strlen(refuge[i].nom) == 0) {
				printf(" Le nom ne peut pas √™tre vide. R√©essaie.\n");
					}
		
				} 
				while (strlen(refuge[i].nom) == 0);
                case 2: // Modification de l‚Äôann√©e de naissance
                    do {
                        printf("Nouvelle ann√©e de naissance : ");
                        scanf("%d", &refuge[i].annee);
                        while (getchar() != '\n');
                    } while (refuge[i].annee < 0); // L‚Äôann√©e doit √™tre positive
                    break;

                case 3: // Modification de l‚Äôesp√®ce
                    do {
                        printf("Nouvelle esp√®ce (1:Chien, 2:Chat, 3:Hamster, 4:Autruche) : ");
                        scanf("%d", (int*)&refuge[i].espece); 
                        while (getchar() != '\n');
                    } while (refuge[i].espece < 1 || refuge[i].espece > 4);
                    break;

                case 4: // Modification du poids
                    do {
                        printf("Nouveau poids : ");
                        scanf("%f", &refuge[i].poids);
                        while (getchar() != '\n');
                    } while (refuge[i].poids < 0); // Le poids doit √™tre positif
                    break;

                case 5: // Modification de la description
                    printf("Nouvelle description : ");
                    fgets(refuge[i].descrip, MAX, stdin);
                    refuge[i].descrip[strcspn(refuge[i].descrip, "\n")] = '\0'; 
                    break;
            }

            printf("‚úÖ Animal modifi√© avec succ√®s !\n");
            afficheAnimal(refuge[i], 1); // Affiche les nouvelles informations apr√®s les modifications
            break; // Sortir de la boucle 
        }
    }

    // Si aucun animal avec l‚ÄôID saisi n‚Äôest trouv√©
    if (trouve == 0) {
        printf("‚ùå Aucun animal trouv√© avec l'ID %d.\n", id);
    }

    // Sauvegarde les changements dans le fichier
    sauvegarder_animaux(); 
}


// Fonction qui calcule la quantit√© totale de croquettes n√©cessaire pour nourrir tous les animaux du refuge en un jour
void day_food() {
    int annee_courante = AnneeCourante();

    float total_croquettes_kg = 0.0; // Initialisation du total de croquettes en kg

    // Parcours de tous les animaux pr√©sents dans le refuge
    for (int i = 0; i < nb_animal; i++) {
        Animal a = refuge[i]; // R√©cup√®re l'animal courant
        int age = annee_courante - a.annee; // Calcule son √¢ge en ann√©es

        // Selon l'esp√®ce de l'animal, on ajoute une quantit√© diff√©rente de croquettes
        switch (a.espece) {
            case hamster:
                total_croquettes_kg += 0.02; // Un hamster mange environ 20g par jour
                break;
            case autruche:
                total_croquettes_kg += 2.5; // Une autruche mange environ 2.5kg par jour
                break;
            case chat:
            case chien:
                if (age < 2) {
                    // Jeunes chiens ou chats (moins de 2 ans) mangent 500g par jour
                    total_croquettes_kg += 0.5;
                } else {
                    // Sinon, ils mangent l'√©quivalent de 10% de leur poids
                    total_croquettes_kg += a.poids * 0.10;
                }
                break;
        }
    }

    // Affichage du r√©sultat final
    printf("\nüçΩÔ∏è  Quantit√© totale de croquettes n√©cessaire aujourd'hui : %.2f kg\n", total_croquettes_kg);
}

// Les esp√®ces sont affich√©es par ordre d√©croissant de leur nombre
void afficherInventaireNbDesc() {
    int compteur[4] = {0};    // Tableau pour compter le nombre d'animaux par esp√®ce
                              // Indices : 0 = chien, 1 = chat, 2 = hamster, 3 = autruche

    int indices[4] = {0, 1, 2, 3}; // Tableau des indices servant √† trier les esp√®ces sans perdre le lien avec leur nom

    // √âtape 1 : Comptage des animaux par esp√®ce
    for (int i = 0; i < nb_animal; i++) {
        if (refuge[i].espece >= chien && refuge[i].espece <= autruche) {
            compteur[refuge[i].espece - 1]++; // On utilise l‚Äô√©num√©ration (d√©butant √† 1)
        }
    }

    // √âtape 2 : Tri des esp√®ces en fonction du nombre d'animaux (ordre d√©croissant)
    for (int i = 0; i < 3; i++) {
        for (int j = i + 1; j < 4; j++) {
            if (compteur[i] < compteur[j]) {
                // √âchange des valeurs de compteur
                int tmp = compteur[i];
                compteur[i] = compteur[j];
                compteur[j] = tmp;

                // √âchange √©galement des indices associ√©s (pour garder les noms coh√©rents)
                int tmpIdx = indices[i];
                indices[i] = indices[j];
                indices[j] = tmpIdx;
            }
        }
    }

    // Tableau des noms des esp√®ces (dans l‚Äôordre d'origine)
    const char *nomsEspeces[4] = { "Chien üê∂", "Chat üê±", "Hamster üêπ", "Autruche üê¶" };

    // Affichage global
    printf("\nüì¶ Nombre total d'animaux : %d\n", nb_animal);
    printf("üìä D√©tail par esp√®ce (ordre d√©croissant) :\n");

    // Affichage des esp√®ces pr√©sentes avec leur nombre, tri√©es par ordre d√©croissant
    for (int i = 0; i < 4; i++) {
        if (compteur[i] > 0) { // On affiche seulement les esp√®ces pr√©sentes
            printf("   - %s : %d\n", nomsEspeces[indices[i]], compteur[i]);
        }
    }
}

// Le calcul d√©pend du type d‚Äôanimal et inclut aussi les cages vides
int day_clean() {
    int total_minutes = 0; // Initialisation du temps total en minutes

    // Parcours de tous les animaux actuellement dans le refuge
    for (int i = 0; i < nb_animal; i++) {
        switch (refuge[i].espece) {
            // Pour chaque esp√®ce, on ajoute le temps de nettoyage correspondant

            case hamster:
                // 10 minutes par jour * 7 jours + 20 minutes de nettoyage hebdomadaire
                total_minutes += (10 * 7) + 20;
                break;

            case chat:
                // 10 minutes par jour * 7 jours + 20 minutes de nettoyage hebdomadaire
                total_minutes += (10 * 7) + 20;
                break;

            case autruche:
                // 20 minutes par jour * 7 jours + 45 minutes de nettoyage hebdomadaire
                total_minutes += (20 * 7) + 45;
                break;

            case chien:
                // 5 minutes par jour * 7 jours + 20 minutes de nettoyage hebdomadaire
                total_minutes += (5 * 7) + 20;
                break;

            default:
                break;
        }
    }

    // Calcul du nombre de cages vides (sur les 50 places disponibles)
    int nb_vides = NbAnimal - nb_animal;

    // On ajoute 2 minutes par jour de nettoyage pour chaque cage vide, pendant 7 jours
    // Donc 2 min/jour * 7 jours = 14 minutes par cage vide sur la semaine
    total_minutes += nb_vides * 14;

    // Retourne le temps total estim√© de nettoyage 
    return total_minutes;
}


void afficherBanniere() {
    printf("\033[1;34m"); 
     printf("\n");
     printf("                 ****   **    **  ********  **       **  **     **        *********  ********    ****   **    **\n");
     printf("                **  **  **    **  **        ** **    **   **   **             **     **         **  **  **    **\n");
     printf("               **       **    **  **        **  **   **    ** **              **     **        **       **    **\n");
     printf("               **       ********  ******    **   **  **     ***               **     ********  **       ********\n");
     printf("               **       **    **  **        **    ** **     ***    ******     **     **        **       **    **\n");
     printf("                **  **  **    **  **        **     ****     ***               **     **         **   ** **    **\n");
     printf("                 ****   **    **  ********  **      ***     ***               **     ********    ****   **    **\n");
     printf("\033[0m"); 
 }
 

// Fonction qui affiche le menu principal et g√®re les choix de l'utilisateur
int afficherMenu() {
    // Affichage du menu  
    printf("\n\033[1;3m"); // Activation du style italique et gras dans le terminal 
    printf("                              ======================== MENU PRINCIPAL ========================\n");
    printf("                              |                                                              |\n");
    printf("                              |   1. ‚ûï Ajouter un animal                                    |\n");
    printf("                              |   2. üîç Rechercher un animal                                 |\n");
    printf("                              |   3. üè† Adopter un animal                                    |\n");
    printf("                              |   4. üì¶ Afficher l'inventaire                                |\n");
    printf("                              |   5. üßΩ Afficher la charge de nettoyage hebdomadaire         |\n");
    printf("                              |   6. üçΩÔ∏è Afficher la quantit√© de nourriture quotidienne       |\n");
    printf("                              |   7. üìù Modifier les informations d‚Äôun animal                |\n");                  
    printf("                              |   8. ‚ùå Quitter le programme                                 |\n");
    printf("                              |______________________________________________________________|\n");
    printf("\033[0m\n"); 
   
    printf("\n‚úÖ Veuillez S√©lectionner Une Action (Tapez 8 Pour Quitter ‚ùå) : ");
	
    int choix;

    scanf("%d", &choix); // Lecture du choix utilisateur
    while (getchar() != '\n'); // Enl√®ve les caract√®res restants (comme "Entr√©e") apr√®s scanf


    // Traitement du choix via un switch
    switch (choix) {
        case 1:
            printf("‚Üí [Ajouter un animal] üê∂\n");
            ajouter_animal(); // Appel √† la fonction pour ajouter un animal
            break;

        case 2:
            printf("‚Üí [Rechercher un animal] üîç\n");
            rechercher_animaux(); // Appel √† la fonction de recherche
            break;

        case 3:
            printf("‚Üí [Retirer un animal] üö™\n");
            adopter_animal(); // Appel √† la fonction pour adopter (retirer) un animal
            break;

        case 4:
            printf("‚Üí [Afficher l'inventaire] üìã\n");
            afficherInventaireNbDesc(); // Appel √† la fonction d'affichage de l'inventaire
            break;

        case 5:
            printf("‚Üí [Afficher charge de travail] üß≥\n");
            {
                // Calcul de la charge de nettoyage hebdomadaire
                int total_minutes = day_clean();
                int heures = total_minutes / 60;
                int minutes = total_minutes % 60;

                // Affichage du r√©sultat sous forme "hh:mm"
                printf("‚è±Ô∏è Charge totale de nettoyage hebdomadaire : %02dh %02dmin\n", heures, minutes);
            }
            break;

        case 6:
            printf("‚Üí [Afficher la quantit√© de croquettes] üçΩÔ∏è\n");
            day_food(); // Appel √† la fonction pour afficher la nourriture quotidienne
            break;

        case 7:
            printf("‚Üí [Modifier un animal] üìù\n");
            modifierAnimal(); // Appel √† la fonction de modification d‚Äôun animal
            break;

        case 8:
            printf("Au revoir ! üëã\n"); // Fin du programme
            break;

        default:
            printf("Choix invalide, r√©essaie ! ‚ùå\n"); // Gestion des entr√©es incorrectes
            break;
    }

    return choix; 
}

int main(){
    int a=0;
    afficherBanniere();
    charger_animaux();
    prochain_id = 1;
    for (int i = 0; i < nb_animal; i++) {
        if (refuge[i].id >= prochain_id){
            prochain_id = refuge[i].id + 1;
        }
}
    while(a != 8){
	   a= afficherMenu();
    }
	
return 0;
}
